# XY.DataRouter

## v1.103.1.22032818

- 增加接口配置 `es_pipeline` 参数, 指定写入 ES 时使用的 Pipeline
- 增加接口配置 `es_disable_write` 参数, 可选不写 ES, 数据仅分发给第三方接口

## v1.103.0.22032111

- 应用泛型

## v1.102.7.22031111

- 简化 `DataRouter` 结构体
- 优化数据项计数
- 优化心跳日志和日志索引

## v1.102.6.22030917

- 优化数据推送配置项

## v1.102.5.22030810

- 升级 Req 支持重试, 增加相应配置
- 升级依赖

## v1.102.4.22022515

- 规范 Init 方法命名, 重构 service 目录结构
- 修改 `/sys/status` 为 `/sys/stats`, 优化变量命名
- 全局协程池增加日志记录器
- 数据分发 PostAPI 增加单次推送最大记录数和最大字节数限制

## v1.102.3.22022410

- 修正 ES 批量写入时采样错误日志记录失败
- 配置 `req` 日志记录器为 `zerolog`
- 数据代理通道日志记录器遵循主配置文件变化
- JSON 响应默认字符集 `utf-8`
- 规范 `Web` 目录结构
- 配置变化时重置文件监听时间间隔
- 优化心跳日志

## v1.102.2.22022111

- 数据分发到多个平台时, 并发推送, 升级 `req v3` 默认使用 `HTTP/2`
- JSON 数据格式化优化
- 优化对无效 ES 数据的排除
- 接口默认启用 `HTTP/1.1`

## v1.102.1.22021616

- 规范 API 响应函数名称和配置项
- 升级 ES 客户端 SDK 为 `v7.17.0`

## v1.102.0.22011818

- 设置缓冲池最大支持 1MiB 的字节切片复用
- 重构配置文件, 配置项分组
- ES 查询语句有误时返回原因
- 接口数据拷贝时使用 bytespool

## v1.101.4.22011717

- 增加数据项初始化时更多的可选函数, 供不同场景优选
- 升级依赖

## v1.101.3.22011417

- 增加 ES 查询多级代理功能:
  - 加密头部携带客户端 IP, 中间代理自动转发
  - 自动识别客户端公网出口, 适配接口 IP 白名单验证, 与直接访问接口行为一致
- 增加 Web 配置项, 客户端 IP, 信任代理白名单等, nginx 反向代理场景适用
- 增加 ES 查询接口日志
- 增加 404 路由

## v1.101.2.22011217

- 增加 `/es/count` 接口, 获取符合条件的索引文档数
- 重构 ES 查询相关代码, 池化, 规范调用
- 重构接口路由目录结构
- 优化数据项相关方法代码, 更新基准测试
- 取消接口返回详细错误信息
- 升级依赖

## v1.101.1.22010721

- 搜索接口和数据写入兼容 ES 7.x 
- 增加配置项 `es_optional_write` 可动态调整基于排队值的繁忙比率定义
  - 繁忙时设置为 `es_optional_write` 的接口数据将不写 ES
  - 增加运行时状态 `ESDataItemDiscards` 显示繁忙时被丢弃的数据项(UDP: 1 个数据, TCP: >=1 个数据)
- 调整可选写入 ES 状态更新的时间间隔, 由 `1minute` 改为 `500ms`

## v1.101.0.22010709

- 调整配置项:
  - 无效 JSON 数据日志由 `Warn` 改为 `Info`
  - ES 慢查询默认值由 `10s` 改为 `5s`
  - ES 默认写入时间间隔由 `0.5s` 改为 `1s`
  - ES 批量写入最小排队数最小值由 `100` 改为 `10`
  - 增加 `es_retry_on_status` ES 重试状态码, 默认: `[502, 503, 504]`
  - 增加 `es_max_retries` ES 重试次数, 默认: `3`
  - 增加 `es_disable_retry` 是否禁止 ES 重试, 默认: `false`
  - 移除 ES 批量写入状态码重试配置
- 运行时状态增加:
  - JSON 库信息
  - ES 服务端和客户端版本信息
- ES `Transport` 使用 `fasthttp`
- 接口响应增加 `APISuccessBytes` 快捷方法
- ES 客户端 SDK 由 `v6.8.10` 升级为 `v7.16.0`
- ES 搜索接口结果解析性能优化
- ES 批量写入方法代码重构

## v1.100.67.21120909

- 启用 HTTPS

## v1.100.66.21120809

- 应用 `gnet` 补丁

## v1.100.63.21113018

- 增加 UDP 获取客户端 IP 的接口: 发送 2 个字节的数据到 UDP 接口即可

## v1.100.62.21112511

- 优化配置文件版本信息

## v1.100.61.21112321

- 接口不存在的错误日志级别由 `ERROR` 调整为 `INFO`

## v1.100.60.21112211

- 优化数据代理通道:
  - 增加数据发送客户端数量, 默认为 CPU * 2, 相应减少每客户端队列大小
  - 客户端发送队列超限后, 强制重新建立连接
  - 服务端接收数据开启异步, 使用 ants 管理协程
  - 开启池化, 优化日志

## v1.100.59.21110119

- 新增 ES 繁忙时丢弃指定索引数据的策略
- 修正 ES 批量提交待处理计数

## v1.100.58.21110111

- 全面池化

## v1.100.56.21102822

- 增加通道数据压缩传输
- 使用 [github.com/fufuok/bytespool](https://github.com/fufuok/bytespool) 替换 `bytebufferpool`

## v1.100.55.21102323

- 优化对象复用

## v1.100.54.21102111

- 减少不必要的指针间接引用
- 全局时间优化

## v1.100.50.21091809

- 调整 `main` 包结构, 增加版本信息
- 优化 `Makefile` 
- 优化 `init()` 减少内部相互依赖, 明确初始化顺序

## v1.100.45.21090909

- 内嵌 `favicon.ico`
- 增加 `/client_ip` `/server_ip` 显示客户端来访 IP 和当前服务器 IP
- 升级依赖包

## v1.100.44.21082808

- 使用 `xsync.NewMap` 替代 `cmap.New`, `xsync.Counter` 替代 `atomic`
- 接口不存在日志记录客户端 IP

## v1.100.43.21082020

- 升级 `go1.17` `utils 0.2.0` 等

## v1.100.42.21080808

- 稳定版本
- 升级依赖包, 规范注释

## v1.100.41.21071515

- 增加 `TunnelDataTotal` `TunnelTodoSendCount` 等, 规范统计字段名称
- 增加配置项 `TunSendQueueSize` 发送数据最大队列长度, 默认: `8192`, 公网大丢包可能超过队列长度而丢弃数据
- `Tunnel` 数据发送不设置超时

## v1.100.40.21071323

- 数据代理由 `WsHub(Websocket)` 替换为 `Tunnel(aRPC)`

## v1.100.31.21070417

- 新增: 无限缓冲信道最大缓冲数量配置(可选) `data_chan_max_buf_cap`
  - 默认为 `0`, 无限大
  - 当前配置 `500000`, 超过限制 `DataChanSize(初始化大小, 默认 50) + DataChanMaxBufCap` 丢弃数据
  - 消费长时间慢于生产, 避免累积数据占用内存过大, 不应该出现该状态 (`WsHubQueueDiscards`)

## v1.100.30.21070323

- 新增: 多级数据代理功能, 解决海外数据上报网络问题
  1. 程序相同, 部署到各地, 可选开启代理 `-f 1.2.3.4:1234`
  2. 就近响应 HTTP/UDP 数据请求 (需配合智能 DNS, 域名解析到就近服务器)
  3. 走专线/环网将数据传递给上联服务器 `1.2.3.4` (可多级传递)
  4. 上联服务器接收到数据后, 在本地继续完成剩下的数据处理和分发逻辑

## v1.100.18.21063012

- 修正: ES 搜索接口中指针在 `go-json` 引发异常

## v1.100.17.21062911

- 增加: 数据处理待办计数等统计项
- 优化: 数据处理创建工作单元时, 排队情况下也不阻塞

## v1.100.16.21062717

- 增加可选配置: `reduce_memory_usage` 减少内存占用(可能增加CPU占用), 默认关闭

## v1.100.15.21062616

- ES 批量写入日志级别配置方式调整
- 增加接口请求黑名单功能

## v1.100.14.21062300

- 优化组路由代码, 严格路由模式, 默认回应请求后立即关闭连接
- 升级依赖到最新, 扩充时间轮精度
- 增加 HTTP 错误请求计数

## v1.100.10.21060500

- 批量提交支持更多数据形式, `/v1/apiname/bulk` 可 POST 多条 JSON 数据 

  1. 现支持数据间用 `=-:-=` 分隔, 如: `{"a":1}=-:-={"b":2}`

  2. 增加支持列表数据, 如: `[{"a":1},{"b":2}]`

  3. 增加支持混搭,如: `{"a":1}=-:-={"b":2}=-:-=[{"c":3},{"d":4}]`

  4. 任意 JSON 格式, 有无美化样式, 换行, 空格都支持, 如:

     ```json
      {
         "a" :
       1 , "b":[
           2,
           3
       ]
     } =-
     :- =[ {"c" :"d" }, {"e":5}] =-:-=
     ```

- 优化 HTTP 接口成功返回值

- 调整初始化顺序, 守护进程更干净

- 启用时间轮, 优化定时器

- 调整关闭写入 ES 时代码逻辑, 数据处理允许的并发最小值调整: `10`

## v1.100.8.21052315

- init
